import express, { Request, Response } from 'express';
import { v4 as uuidv4 } from 'uuid';
import os from 'os';

import { classifyHeaders } from './utils/headerClassifier';
import { parseUserAgent } from './utils/userAgentParser';
import { extractGeoInfo } from './utils/geoExtractor';

const app = express();
const PORT = parseInt(process.env.PORT ?? '3000', 10);

// Enable trust proxy for accurate IP resolution behind reverse proxies / load balancers
app.set('trust proxy', true);

/**
 * Builds a production-grade, categorized audit object from an incoming request.
 */
function buildRequestAudit(req: Request) {
    const now = new Date();

    // â”€â”€ Meta â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const meta = {
        timestamp: now.toISOString(),
        unixTimestamp: now.getTime(),
        requestId: (req.headers['x-request-id'] as string) ?? uuidv4(),
        serverHostname: os.hostname(),
        nodeVersion: process.version,
        processId: process.pid,
        uptime: Math.round(process.uptime()),
    };

    // â”€â”€ Client â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const client = {
        ip: req.ip ?? req.socket.remoteAddress ?? 'unknown',
        ips: req.ips.length > 0 ? req.ips : undefined,
        port: req.socket.remotePort ?? null,
        forwardedFor: (req.headers['x-forwarded-for'] as string) ?? null,
        forwardedProto: (req.headers['x-forwarded-proto'] as string) ?? null,
        realIp: (req.headers['x-real-ip'] as string) ?? null,
    };

    // â”€â”€ Request â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const request = {
        method: req.method,
        url: req.originalUrl,
        path: req.path,
        queryParams: req.query,
        httpVersion: req.httpVersion,
        protocol: req.protocol,
        secure: req.secure,
        hostname: req.hostname,
        contentLength: req.headers['content-length']
            ? parseInt(req.headers['content-length'], 10)
            : null,
        contentType: req.headers['content-type'] ?? null,
    };

    // â”€â”€ User Agent â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const userAgent = parseUserAgent(req.headers['user-agent']);

    // â”€â”€ Headers (classified & redacted) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const headers = classifyHeaders(req.headers);

    // â”€â”€ TLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const tlsSocket = (req.socket as any);
    const tls = {
        encrypted: !!tlsSocket.encrypted,
        protocol: tlsSocket.getProtocol?.() ?? null,
        cipher: tlsSocket.getCipher?.()?.name ?? null,
        authorized: tlsSocket.authorized ?? null,
    };

    // â”€â”€ Geo (from CDN/proxy headers) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const geo = extractGeoInfo(req.headers);

    return {
        meta,
        client,
        request,
        userAgent,
        headers,
        tls,
        geo,
    };
}

// â”€â”€ Routes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.get('/', (req: Request, res: Response) => {
    const audit = buildRequestAudit(req);

    // Log prettified audit to console
    console.log('\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('  ðŸ“¥  Incoming Request Audit');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log(JSON.stringify(audit, null, 2));
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');

    res.status(200).json(audit);
});

// â”€â”€ Start Server â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.listen(PORT, () => {
    console.log(`\nðŸš€ Request Info Parser API`);
    console.log(`   Listening on http://localhost:${PORT}`);
    console.log(`   Node ${process.version} | PID ${process.pid} | Host ${os.hostname()}\n`);
});
